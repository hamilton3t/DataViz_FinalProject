---
title: "Final Project: Tour de France"
author: "Tristan Hamilton"
format: 
  html:
    embed-resources: true
---

https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md

```{r}
library(tdf)
library(tidyverse)
library(lubridate)
library(plotly)
```


```{r}
winners <- winners |>
  mutate(year = year(start_date))

winners_age <- winners |> group_by(edition, year, winner_name, winner_team) |>
  summarise(winner_age = mean(age))

winners_wins <- winners |> group_by(edition, year, winner_name, winner_team) |>
  summarise(stage_wins = sum(stage_wins))

winners <- winners |> mutate(age_range = case_when(age <= 23 ~ "Young",
                                                   age > 23 & age <= 32 ~ "Average",
                                                   age > 32 ~ "Old"))
age_bracket_count <- winners |> group_by(age_range) |>
  summarise(num = n())


overall_age <- mean(winners$age)
overall_age2 <- median(winners$age)

winners_df2 <- winners_age |> left_join(winners_wins, by = c("edition", "year", "winner_name", "winner_team"))

winners_df3 <- winners |>
  select(winner_name, distance, time_overall, time_margin)

top_riders <- winners_df2 |> group_by(winner_name) |>
  summarise(tdf_wins = n()) |>
  arrange(desc(tdf_wins)) |>
  slice(1:6)


winners_plot <- ggplot(data = winners_df2, aes(x = year, y = winner_age, label = winner_name, label2 = stage_wins)) +
  geom_line(colour = "deepskyblue1") +
  geom_point(size = 0.75) +
  geom_hline(yintercept = overall_age, colour = "red", linewidth = 0.5) +
  # geom_hline(yintercept = overall_age2, colour = "darkorange", linewidth = 0.5) +
  theme_classic() +
  labs(title = "Ages of Tour de France Winners",
       x = "Year",
       y = "Age of Winner") 

ggplotly(winners_plot)

### looking at mean age of TDF winners

### user can select winner which will highlight the point(s) 
```


```{r}
## country wins
country_wins <- winners |> group_by(nationality) |>
  summarise(country_wins = n()) |>
  arrange(desc(country_wins)) |>
  slice(1:7)

ggplot(data = country_wins, aes(x = reorder(nationality, country_wins), y = country_wins)) +
  geom_col(fill = "darkorange2", colour = "black") +
  coord_flip() +
  theme_minimal() +
  labs(x = "Country",
       y = "Number of TDF Wins")
```

```{r}
## country wins 2
country_wins <- winners |> group_by(nationality) |>
  summarise(country_wins = n()) |>
  arrange(desc(country_wins)) 

ggplot(data = country_wins, aes(x = reorder(nationality, country_wins), y = country_wins)) +
  geom_col(fill = "deepskyblue3", colour = "black") +
  coord_flip() +
  theme_minimal() +
  labs(x = "Country",
       y = "Number of TDF Wins")

## next, in shiny, add plotly so user can hover over either of the graphs and it will display the number of tdf wins for that country. 

## then add more tabs with more interesting info
```

```{r}
## not sure if I'll do something with this
## distance 
winners |> group_by(year) |>
  summarise(tdf_distance = max(distance)) |>
  arrange(desc(tdf_distance))

avg_distance_km <- mean(winners$distance)

ggplot(data = winners, aes(x = time_overall, y = distance)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = avg_distance_km, colour = "red2")
```


```{r}
library(shiny)
library(ggrepel)

rider_choices <- winners_df2 |> distinct(winner_name) |> pull(winner_name)
ui <- fluidPage(
  tabsetPanel(
    tabPanel("Age: TDF Winners",
      sidebarLayout(
        sidebarPanel(
          selectInput("rider_sel",
                      label = "Choose a Tour de France Winner:",
                      choices = rider_choices),
        ),
        mainPanel(
          plotOutput("winners_plot2"),
          tableOutput("data"),
          tableOutput("data2"),
        )
      )
    ),
    tabPanel("Countries: TDF Winners",
             radioButtons("output_select",
                          label = "Choose Display:",
                          choices = c("Top-Performing Countries", "All Countries"),
                          selected = "Top-Performing Countries"),
             mainPanel(
               plotOutput("country_plot"),
             )
    )
  ),
)

server <- function(input, output, session) {
  
  winner_reactive <- reactive({
    winners_df2 |> filter(winner_name == input$rider_sel)
  })
  
  winner_reactive2 <- reactive({
    winners_df3 |> filter(winner_name == input$rider_sel)
  })
  
  output$winners_plot2 <- renderPlot({
    ggplot(data = winners_df2, aes(x = year, y = winner_age)) +
      geom_line(colour = "deepskyblue1") +
      geom_point(size = 0.75) +
      geom_point(data = winner_reactive(), aes(x = year, y = winner_age), 
                 colour = "red", size = 4) +
      geom_hline(yintercept = overall_age, colour = "darkorange", linewidth = 0.5) +
      theme_classic(base_size = 20) +
      labs(title = "Ages of Tour de France Winners",
           #subtitle = glue::glue(input$rider_sel),
           x = "Year",
           y = "Age of Winner")
    
  })
  
  ## clean these tables up next
    
  output$data <- renderTable({
    winner_reactive()
  })
  
  output$data2 <- renderTable({
    winner_reactive2()
  })
  
  ## nationality output
  
  output$country_plot <- renderPlot({
    if (input$output_select == "Top-Performing Countries") {
      
      country_wins <- winners |> group_by(nationality) |>
        summarise(country_wins = n()) |>
        arrange(desc(country_wins)) |>
        slice(1:7)
      
      ggplot(data = country_wins, aes(x = reorder(nationality, country_wins), 
                                      y = country_wins)) +
        geom_col(fill = "darkorange2", colour = "black") +
        coord_flip() +
        theme_minimal() +
        labs(x = "Country",
             y = "Number of TDF Wins")
    }
    else {
      country_wins <- winners |> group_by(nationality) |>
        summarise(country_wins = n()) |>
        arrange(desc(country_wins)) 
      
      ggplot(data = country_wins, aes(x = reorder(nationality, country_wins), 
                                      y = country_wins)) +
        geom_col(fill = "deepskyblue3", colour = "black") +
        coord_flip() +
        theme_minimal() +
        labs(x = "Country",
             y = "Number of TDF Wins")
      
    }
    
  })
  
}

shinyApp(ui, server)
```

